openapi: 3.0.3
info:
  title: Court Booking Backend API
  version: "v1"
  description: |
    Court Booking Backend — API v1
    使用者自行註冊，管理員將既有使用者加入組織並設定角色 (owner/admin/member)。
    文件同時包含中文註解 (繁體) 以利團隊溝通.
servers:
  - url: http://localhost:8082/v1
    description: Local Server
security:
  - bearerAuth: []

tags:
  - name: Auth
    description: 認證 / 註冊 / 登入
  - name: Me
    description: 目前使用者資訊
  - name: Users
    description: System Admin 管理 Users
  - name: Organizations
    description: 組織管理
  - name: Members
    description: 組織成員與權限
  - name: Locations
    description: 實體場館
  - name: ResourceTypes
    description: 場地類型
  - name: Resources
    description: 實際場地 (field / court)
  - name: Bookings
    description: 預約相關
  - name: Announcements
    description: 公告

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
      description: Page number (start from 1)
    page_size:
      name: page_size
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      description: Items per page
    sort:
      name: sort
      in: query
      schema:
        type: string
      description: Sort fields, comma separated. Prefix with '-' for desc. e.g. sort=-created_at,email

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: machine-readable error code
            message:
              type: string
              description: human readable message
      example:
        error:
          code: "booking_conflict"
          message: "Booking time overlaps with existing booking"

    PageResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        display_name:
          type: string
        created_at:
          type: string
          format: date-time
        last_login_at:
          type: string
          format: date-time
          nullable: true
        is_active:
          type: boolean
        is_system_admin:
          type: boolean
      required:
        - id
        - email
        - created_at
        - is_active
        - is_system_admin

    RegisterRequest:
      type: object
      properties:
        email:
          type: string
        password:
          type: string
        display_name:
          type: string
      required:
        - email
        - password

    LoginRequest:
      type: object
      properties:
        email:
          type: string
        password:
          type: string
      required:
        - email
        - password

    AuthResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
      example:
        access_token: "eyJhbGciOiJ..."
        token_type: "Bearer"

    Organization:
      type: object
      properties:
        id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time

    OrganizationCreate:
      type: object
      properties:
        name:
          type: string
      required:
        - name

    OrganizationMember:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [owner, admin, member]

    Location:
      type: object
      properties:
        id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        organization_id:
          type: integer
        capacity:
          type: integer
        opening_hours_start:
          type: string
          description: "time (HH:MM:SS)"
        opening_hours_end:
          type: string
          description: "time (HH:MM:SS)"
        location_info:
          type: string
        opening:
          type: boolean
        rule:
          type: string
        facility:
          type: string
        description:
          type: string
        longitude:
          type: number
        latitude:
          type: number

    ResourceType:
      type: object
      properties:
        id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        organization_id:
          type: integer

    Resource:
      type: object
      properties:
        id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        resource_type_id:
          type: integer
        location_id:
          type: integer

    Booking:
      type: object
      properties:
        id:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        resource_id:
          type: integer
        user_id:
          type: string
          format: uuid
        start_time:
          type: string
          format: date-time
          description: ISO8601 with timezone; server stores UTC
        end_time:
          type: string
          format: date-time
        status:
          type: string
          enum: [pending, confirmed, cancelled]
      required:
        - id
        - resource_id
        - user_id
        - start_time
        - end_time
        - status

    BookingCreate:
      type: object
      properties:
        resource_id:
          type: integer
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
      required:
        - resource_id
        - start_time
        - end_time

    Announcement:
      type: object
      properties:
        id:
          type: integer
        created_at:
          type: string
          format: date-time
        title:
          type: string
        content:
          type: string

paths:
  /auth/register:
    post:
      tags:
        - Auth
      summary: "使用者註冊 (User self-register)"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/login:
    post:
      tags:
        - Auth
      summary: "登入 (Login)"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Auth success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /me:
    get:
      tags:
        - Me
      summary: "取得目前使用者資訊 (Get current user)"
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users:
    get:
      tags:
        - Users
      summary: "列出使用者（System Admin）"
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - $ref: "#/components/parameters/sort"
        - name: email
          in: query
          schema:
            type: string
        - name: display_name
          in: query
          schema:
            type: string
        - name: is_active
          in: query
          schema:
            type: boolean
      responses:
        "200":
          description: paged users
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
        "403":
          description: Forbidden

  /users/{user_id}:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Users
      summary: "取得單一使用者（System Admin）"
      security:
        - bearerAuth: []
      responses:
        "200":
          description: user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "403":
          description: Forbidden
        "404":
          description: Not found
    patch:
      tags:
        - Users
      summary: "更新使用者（System Admin）"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                display_name:
                  type: string
                is_active:
                  type: boolean
                is_system_admin:
                  type: boolean
      responses:
        "200":
          description: updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "403":
          description: Forbidden
        "404":
          description: Not found

  /organizations:
    get:
      tags:
        - Organizations
      summary: "列出 organizations"
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
      responses:
        "200":
          description: paged organizations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Organizations
      summary: "建立 organization (System Admin)"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrganizationCreate"
      responses:
        "201":
          description: created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
        "403":
          description: Forbidden

  /organizations/{org_id}:
    parameters:
      - name: org_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Organizations
      summary: "取得單一 organization"
      security:
        - bearerAuth: []
      responses:
        "200":
          description: organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Organization"
        "404":
          description: Not found
    patch:
      tags:
        - Organizations
      summary: "更新 organization (System Admin or owner)"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Organizations
      summary: "刪除或停用 organization"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted

  /organizations/{org_id}/members:
    parameters:
      - name: org_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Members
      summary: "列出 organization 成員"
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          schema:
            type: string
            enum: [owner, admin, member]
      responses:
        "200":
          description: member list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Members
      summary: "把既有 user 加入 organization 並指定 role (owner/admin/member)"
      description: "Body: { user_id, role }。若要用 email 搜尋 user，前端可先 GET /users?email=... 取得 user_id。"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                  format: uuid
                role:
                  type: string
                  enum: [owner, admin, member]
              required:
                - user_id
                - role
      responses:
        "201":
          description: created membership
        "403":
          description: Forbidden
        "404":
          description: User not found

  /organizations/{org_id}/members/{user_id}:
    parameters:
      - name: org_id
        in: path
        required: true
        schema:
          type: integer
      - name: user_id
        in: path
        required: true
        schema:
          type: string
          format: uuid
    patch:
      tags:
        - Members
      summary: "調整該 member 在 organization 的角色"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                  enum: [owner, admin, member]
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Members
      summary: "把 user 從 organization 移除"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: removed

  /locations:
    get:
      tags:
        - Locations
      summary: "列出 locations"
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - name: organization_id
          in: query
          schema:
            type: integer
        - name: q
          in: query
          schema:
            type: string
            description: keyword search
      responses:
        "200":
          description: paged locations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Locations
      summary: "建立 location (org owner/admin)"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Location"
      responses:
        "201":
          description: created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Location"

  /locations/{location_id}:
    parameters:
      - name: location_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Locations
      summary: "取得單一 location"
      responses:
        "200":
          description: location
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Location"
        "404":
          description: Not found
    patch:
      tags:
        - Locations
      summary: "更新 location"
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Location"
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Locations
      summary: "刪除或停用 location"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted

  /resource-types:
    get:
      tags:
        - ResourceTypes
      summary: "列出 resource types"
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - name: organization_id
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: paged resource types
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - ResourceTypes
      summary: "建立 resource type"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResourceType"
      responses:
        "201":
          description: created

  /resource-types/{type_id}:
    parameters:
      - name: type_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - ResourceTypes
      summary: "取得 resource type"
      responses:
        "200":
          description: resource type
    patch:
      tags:
        - ResourceTypes
      summary: "更新 resource type"
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResourceType"
      responses:
        "200":
          description: updated
    delete:
      tags:
        - ResourceTypes
      summary: "刪除 resource type"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted

  /resources:
    get:
      tags:
        - Resources
      summary: "列出 resources (fields/courts)"
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - name: resource_type_id
          in: query
          schema:
            type: integer
        - name: location_id
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: paged resources
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Resources
      summary: "建立 resource"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Resource"
      responses:
        "201":
          description: created

  /resources/{resource_id}:
    parameters:
      - name: resource_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Resources
      summary: "取得 resource"
      responses:
        "200":
          description: resource
    patch:
      tags:
        - Resources
      summary: "更新 resource"
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Resource"
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Resources
      summary: "刪除 resource"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted

  /bookings:
    get:
      tags:
        - Bookings
      summary: "列出 bookings"
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: resource_id
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, cancelled]
        - name: start_time_from
          in: query
          schema:
            type: string
            format: date-time
        - name: start_time_to
          in: query
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: paged bookings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Bookings
      summary: "建立 booking (user)"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BookingCreate"
      responses:
        "201":
          description: created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Booking"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Conflict (overlap)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /bookings/{booking_id}:
    parameters:
      - name: booking_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Bookings
      summary: "取得 booking"
      security:
        - bearerAuth: []
      responses:
        "200":
          description: booking
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Booking"
        "403":
          description: Forbidden
        "404":
          description: Not found
    patch:
      tags:
        - Bookings
      summary: "更新 booking"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                start_time:
                  type: string
                  format: date-time
                end_time:
                  type: string
                  format: date-time
                status:
                  type: string
                  enum: [pending, confirmed, cancelled]
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Bookings
      summary: "刪除 / 取消 booking"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted

  /announcements:
    get:
      tags:
        - Announcements
      summary: "列出公告"
      parameters:
        - $ref: "#/components/parameters/page"
        - $ref: "#/components/parameters/page_size"
      responses:
        "200":
          description: paged announcements
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PageResponse"
    post:
      tags:
        - Announcements
      summary: "建立公告 (System Admin)"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Announcement"
      responses:
        "201":
          description: created

  /announcements/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Announcements
      summary: "取得公告"
      responses:
        "200":
          description: announcement
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Announcement"
        "404":
          description: Not found
    patch:
      tags:
        - Announcements
      summary: "更新公告 (System Admin 或 owner)"
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Announcement"
      responses:
        "200":
          description: updated
    delete:
      tags:
        - Announcements
      summary: "刪除公告"
      security:
        - bearerAuth: []
      responses:
        "204":
          description: deleted
